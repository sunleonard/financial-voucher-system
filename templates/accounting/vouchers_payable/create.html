{% extends "base.html" %}

{% block title %}Create Voucher Payable{% endblock %}
{% block page_title %}Create New Voucher Payable{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-file-invoice-dollar me-2"></i>Create Voucher Payable
                </h5>
                <p class="mb-0 text-muted">Record a new liability - money owed to suppliers/vendors</p>
            </div>
            <div class="card-body">
                <form method="POST" id="voucherForm">
                    <!-- Transaction Date and Due Date -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="transaction_date" class="form-label">Transaction Date <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="transaction_date" name="transaction_date" 
                                       value="{{ moment().format('YYYY-MM-DD') }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="due_date" class="form-label">Due Date</label>
                                <input type="date" class="form-control" id="due_date" name="due_date">
                                <div class="form-text">Optional payment due date</div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Payee Selection -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="payee_code" class="form-label">Payee <span class="text-danger">*</span></label>
                                <select class="form-select" id="payee_code" name="payee_code" required>
                                    <option value="">Select Payee</option>
                                    {% for payee in payees %}
                                    <option value="{{ payee.acct_code }}">
                                        {{ payee.acct_description }} ({{ payee.acct_code }})
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">
                                    <a href="{{ url_for('accounting.create_payee') }}" target="_blank" id="addPayeeBtn">
                                        Add new payee
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="total_amount" class="form-label">Total Amount <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="total_amount" name="total_amount" 
                                           step="0.01" min="0.01" required onchange="validateAmount()">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="mb-3">
                        <label for="description" class="form-label">Description <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="description" name="description" rows="2" required
                                  placeholder="Brief description of the expense or obligation"></textarea>
                    </div>

                    <!-- Advanced Credit/Debit Lines (Collapsible) -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <button class="btn btn-link p-0 text-decoration-none" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#advancedAccounting">
                                <i class="fas fa-chevron-down me-2"></i>Advanced Accounting (Optional)
                            </button>
                        </div>
                        <div class="collapse" id="advancedAccounting">
                            <div class="card-body">
                                <!-- Credit/Debit Lines -->
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="form-label mb-0">Credit/Debit Lines</label>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addCreditDebitLine()">
                                            <i class="fas fa-plus me-1"></i>Add Line
                                        </button>
                                    </div>
                                    <div id="creditDebitLines">
                                        <!-- Dynamic credit/debit lines will be added here -->
                                    </div>
                                </div>

                                <!-- Subsidiary Lines -->
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="form-label mb-0">Subsidiary Breakdown</label>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addSubsidiaryLine()">
                                            <i class="fas fa-plus me-1"></i>Add Subsidiary
                                        </button>
                                    </div>
                                    <div id="subsidiaryLines">
                                        <!-- Dynamic subsidiary lines will be added here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hidden fields for counting lines -->
                    <input type="hidden" id="cd_line_count" name="cd_line_count" value="0">
                    <input type="hidden" id="sub_line_count" name="sub_line_count" value="0">
                    
                    <!-- Form Actions -->
                    <div class="d-flex gap-2 mt-4">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Create Voucher Payable
                        </button>
                        <a href="{{ url_for('accounting.list_vouchers_payable') }}" class="btn btn-secondary">
                            <i class="fas fa-times me-2"></i>Cancel
                        </a>
                        <button type="button" class="btn btn-outline-info" onclick="validateBalance()">
                            <i class="fas fa-calculator me-2"></i>Check Balance
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Help Panel -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">Voucher Payable Guide</h6>
            </div>
            <div class="card-body">
                <h6 class="text-primary">What is a Voucher Payable?</h6>
                <p class="small">A VP records an obligation to pay a vendor or supplier. It creates a liability on your books until payment is made.</p>
                
                <h6 class="text-primary mt-3">Double-Entry Impact</h6>
                <ul class="small">
                    <li><strong>Debit:</strong> Expense or Asset account</li>
                    <li><strong>Credit:</strong> Accounts Payable</li>
                </ul>
                
                <h6 class="text-primary mt-3">Next Steps</h6>
                <p class="small">After creating this VP, you can:</p>
                <ul class="small">
                    <li>Review and approve the voucher</li>
                    <li>Create a Check Voucher to pay it</li>
                    <li>Track payment status</li>
                </ul>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h6 class="card-title mb-0">Quick Actions</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('accounting.list_payees') }}" class="btn btn-outline-primary">
                        <i class="fas fa-users me-2"></i>Manage Payees
                    </a>
                    <a href="{{ url_for('accounting.create_payee') }}" class="btn btn-outline-success">
                        <i class="fas fa-user-plus me-2"></i>Add New Payee
                    </a>
                    <a href="{{ url_for('accounting.list_vouchers_payable') }}" class="btn btn-outline-info">
                        <i class="fas fa-list me-2"></i>View All VPs
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let cdLineCount = 0;
let subLineCount = 0;

// Enhanced Payee Search and Selection
document.addEventListener('DOMContentLoaded', function() {
    const payeeSelect = document.getElementById('payee_code');
    const addPayeeBtn = document.getElementById('addPayeeBtn');
    
    // Enhanced payee search with autocomplete
    if (payeeSelect) {
        // Convert select to searchable input with dropdown
        createPayeeSearchField();
    }
    
    // Pre-select payee if coming from payee management
    const urlParams = new URLSearchParams(window.location.search);
    const preselectedPayee = urlParams.get('payee');
    if (preselectedPayee && payeeSelect) {
        payeeSelect.value = preselectedPayee;
        loadPayeeDetails(preselectedPayee);
    }
});

function createPayeeSearchField() {
    const payeeSelect = document.getElementById('payee_code');
    if (!payeeSelect) return;
    
    // Create new search input
    const searchContainer = document.createElement('div');
    searchContainer.className = 'position-relative';
    
    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.className = 'form-control';
    searchInput.placeholder = 'Search payees by name or code...';
    searchInput.setAttribute('autocomplete', 'off');
    
    const dropdown = document.createElement('div');
    dropdown.className = 'dropdown-menu w-100';
    dropdown.style.maxHeight = '200px';
    dropdown.style.overflowY = 'auto';
    
    searchContainer.appendChild(searchInput);
    searchContainer.appendChild(dropdown);
    
    // Replace select with search input
    payeeSelect.style.display = 'none';
    payeeSelect.parentNode.insertBefore(searchContainer, payeeSelect.nextSibling);
    
    let searchTimeout;
    
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        
        if (query.length < 2) {
            dropdown.classList.remove('show');
            return;
        }
        
        searchTimeout = setTimeout(() => {
            searchPayees(query, dropdown, searchInput, payeeSelect);
        }, 300);
    });
    
    searchInput.addEventListener('focus', function() {
        if (this.value.length >= 2) {
            dropdown.classList.add('show');
        }
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchContainer.contains(e.target)) {
            dropdown.classList.remove('show');
        }
    });
}

function searchPayees(query, dropdown, searchInput, payeeSelect) {
    fetch(`/accounting/api/payees/search?q=${encodeURIComponent(query)}&limit=10`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayPayeeSearchResults(data.payees, dropdown, searchInput, payeeSelect);
            }
        })
        .catch(error => {
            console.error('Error searching payees:', error);
        });
}

function displayPayeeSearchResults(payees, dropdown, searchInput, payeeSelect) {
    dropdown.innerHTML = '';
    
    if (payees.length === 0) {
        const noResults = document.createElement('div');
        noResults.className = 'dropdown-item-text text-muted';
        noResults.textContent = 'No payees found';
        dropdown.appendChild(noResults);
    } else {
        payees.forEach(payee => {
            const item = document.createElement('a');
            item.className = 'dropdown-item';
            item.href = '#';
            item.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${payee.code}</strong> - ${payee.name}
                        <br><small class="text-muted">${payee.type}</small>
                    </div>
                    <span class="badge bg-${payee.type === 'Company' ? 'primary' : payee.type === 'Customer' ? 'success' : payee.type === 'Employee' ? 'info' : 'warning'}">
                        ${payee.type}
                    </span>
                </div>
            `;
            
            item.addEventListener('click', function(e) {
                e.preventDefault();
                selectPayee(payee, searchInput, payeeSelect, dropdown);
            });
            
            dropdown.appendChild(item);
        });
        
        // Add "Create New Payee" option
        const createNew = document.createElement('div');
        createNew.className = 'dropdown-divider';
        dropdown.appendChild(createNew);
        
        const createNewItem = document.createElement('a');
        createNewItem.className = 'dropdown-item text-success';
        createNewItem.href = '#';
        createNewItem.innerHTML = '<i class="fas fa-plus me-2"></i>Create New Payee';
        createNewItem.addEventListener('click', function(e) {
            e.preventDefault();
            openCreatePayeeModal();
        });
        dropdown.appendChild(createNewItem);
    }
    
    dropdown.classList.add('show');
}

function selectPayee(payee, searchInput, payeeSelect, dropdown) {
    searchInput.value = `${payee.code} - ${payee.name}`;
    payeeSelect.value = payee.code;
    dropdown.classList.remove('show');
    
    // Load additional payee details
    loadPayeeDetails(payee.code);
    
    // Trigger change event
    payeeSelect.dispatchEvent(new Event('change'));
}

function loadPayeeDetails(payeeCode) {
    if (!payeeCode) return;
    
    fetch(`/accounting/api/payees/${payeeCode}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayPayeeInfo(data);
            }
        })
        .catch(error => {
            console.error('Error loading payee details:', error);
        });
}

function displayPayeeInfo(payeeData) {
    // Show payee information panel
    let infoPanel = document.getElementById('payeeInfo');
    if (!infoPanel) {
        infoPanel = document.createElement('div');
        infoPanel.id = 'payeeInfo';
        infoPanel.className = 'alert alert-info mt-2';
        
        const payeeContainer = document.getElementById('payee_code').closest('.mb-3');
        payeeContainer.appendChild(infoPanel);
    }
    
    infoPanel.innerHTML = `
        <div class="row">
            <div class="col-md-8">
                <h6 class="mb-1">${payeeData.payee.name}</h6>
                <small class="text-muted">
                    ${payeeData.payee.code} • ${payeeData.payee.type}
                    ${payeeData.summary.outstanding_balance > 0 ? 
                        ` • Outstanding: $${payeeData.summary.outstanding_balance.toFixed(2)}` : ''}
                </small>
            </div>
            <div class="col-md-4 text-end">
                <small class="text-muted">
                    ${payeeData.summary.transaction_count} transactions<br>
                    Last: ${payeeData.recent_transactions.length > 0 ? 
                        payeeData.recent_transactions[0].date : 'None'}
                </small>
            </div>
        </div>
        <div class="mt-2">
            <a href="/accounting/payees/${payeeData.payee.code}" target="_blank" class="btn btn-sm btn-outline-info">
                <i class="fas fa-eye me-1"></i>View Details
            </a>
        </div>
    `;
}

function openCreatePayeeModal() {
    // Open create payee form in a new window/modal
    const createPayeeUrl = "/accounting/payees/create?popup=1";
    const popup = window.open(
        createPayeeUrl, 
        'CreatePayee', 
        'width=800,height=600,scrollbars=yes,resizable=yes'
    );
    
    // Listen for payee creation completion
    const checkClosed = setInterval(function() {
        if (popup.closed) {
            clearInterval(checkClosed);
            // Refresh payee list or reload current payee search
            location.reload();
        }
    }, 1000);
}

// Enhanced amount validation with payee context
function validateAmount() {
    const amount = parseFloat(document.getElementById('total_amount').value);
    const payeeCode = document.getElementById('payee_code').value;
    
    if (!amount || !payeeCode) return;
    
    // Show warning for unusually large amounts
    if (amount > 10000) {
        showAmountWarning('Large amount detected. Please verify this is correct.');
    }
    
    // Check against payee's typical amounts
    loadPayeeDetails(payeeCode);
}

function showAmountWarning(message) {
    let warningEl = document.getElementById('amountWarning');
    if (!warningEl) {
        warningEl = document.createElement('div');
        warningEl.id = 'amountWarning';
        warningEl.className = 'alert alert-warning mt-2';
        
        const amountContainer = document.getElementById('total_amount').closest('.mb-3');
        amountContainer.appendChild(warningEl);
    }
    
    warningEl.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>${message}`;
}

function addCreditDebitLine() {
    const container = document.getElementById('creditDebitLines');
    const lineNumber = cdLineCount++;
    
    const lineHtml = `
        <div class="row mb-2 cd-line" id="cdLine${lineNumber}">
            <div class="col-md-3">
                <input type="text" class="form-control" name="cd_acct_code_${lineNumber}" 
                       placeholder="Account Code" required>
            </div>
            <div class="col-md-4">
                <input type="text" class="form-control" name="cd_acct_desc_${lineNumber}" 
                       placeholder="Description">
            </div>
            <div class="col-md-2">
                <input type="number" class="form-control" name="cd_amount_${lineNumber}" 
                       placeholder="Amount" step="0.01" required>
            </div>
            <div class="col-md-2">
                <select class="form-select" name="cd_acct_type_${lineNumber}" required>
                    <option value="">Type</option>
                    <option value="D">Debit</option>
                    <option value="C">Credit</option>
                </select>
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeLine('cdLine${lineNumber}')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', lineHtml);
    document.getElementById('cd_line_count').value = cdLineCount;
}

function addSubsidiaryLine() {
    const container = document.getElementById('subsidiaryLines');
    const lineNumber = subLineCount++;
    
    const lineHtml = `
        <div class="row mb-2 sub-line" id="subLine${lineNumber}">
            <div class="col-md-3">
                <input type="text" class="form-control" name="sub_code_${lineNumber}" 
                       placeholder="Sub Code" required>
            </div>
            <div class="col-md-6">
                <input type="text" class="form-control" name="sub_desc_${lineNumber}" 
                       placeholder="Description">
            </div>
            <div class="col-md-2">
                <input type="number" class="form-control" name="sub_amount_${lineNumber}" 
                       placeholder="Amount" step="0.01" required>
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeLine('subLine${lineNumber}')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', lineHtml);
    document.getElementById('sub_line_count').value = subLineCount;
}

function removeLine(lineId) {
    document.getElementById(lineId).remove();
}

function validateBalance() {
    const totalAmount = parseFloat(document.getElementById('total_amount').value) || 0;
    const cdLines = document.querySelectorAll('.cd-line');
    
    let totalDebits = 0;
    let totalCredits = 0;
    
    cdLines.forEach(line => {
        const amount = parseFloat(line.querySelector('input[name*="amount"]').value) || 0;
        const type = line.querySelector('select[name*="type"]').value;
        
        if (type === 'D') totalDebits += amount;
        if (type === 'C') totalCredits += amount;
    });
    
    const isBalanced = Math.abs(totalDebits - totalCredits) < 0.01;
    const message = isBalanced ? 
        '✅ Credit/Debit lines are balanced!' : 
        `⚠️ Not balanced: Debits $${totalDebits.toFixed(2)}, Credits $${totalCredits.toFixed(2)}`;
    
    alert(message);
}
</script>
{% endblock %}
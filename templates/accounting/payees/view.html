<!-- templates/accounting/payees/view.html -->
{% extends "base.html" %}

{% block title %}{{ payee.acct_description }} - Payee Details{% endblock %}
{% block page_title %}Payee Details{% endblock %}

{% block content %}
<!-- Payee Header -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h3>{{ payee.acct_description }}</h3>
                        <p class="text-muted mb-2">
                            <strong>Code:</strong> {{ payee.acct_code }} â€¢ 
                            <strong>Type:</strong> 
                            <span class="badge bg-{{ 
                                'primary' if payee.acct_type == 'Company' 
                                else 'success' if payee.acct_type == 'Customer'
                                else 'info' if payee.acct_type == 'Employee'
                                else 'warning' 
                            }}">{{ payee.acct_type }}</span>
                        </p>
                        {% if payee.acct_prefix %}
                        <p class="text-muted mb-0">
                            <strong>Prefix:</strong> <span class="badge bg-light text-dark">{{ payee.acct_prefix }}</span>
                        </p>
                        {% endif %}
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="btn-group" role="group">
                            <a href="{{ url_for('accounting.create_voucher_payable') }}?payee={{ payee.acct_code }}" 
                               class="btn btn-success">
                                <i class="fas fa-file-invoice me-2"></i>Create VP
                            </a>
                            <a href="{{ url_for('accounting.create_check_voucher') }}?payee={{ payee.acct_code }}" 
                               class="btn btn-primary">
                                <i class="fas fa-check me-2"></i>Create CV
                            </a>
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-cog"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li>
                                        <a class="dropdown-item" href="{{ url_for('accounting.edit_payee', payee_code=payee.acct_code) }}">
                                            <i class="fas fa-edit me-2"></i>Edit Payee
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item" href="#" onclick="exportPayeeData()">
                                            <i class="fas fa-download me-2"></i>Export Data
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">Financial Summary</h6>
            </div>
            <div class="card-body">
                <div class="row text-center mb-3">
                    <div class="col-12">
                        <div class="h4 text-{{ 'warning' if summary.outstanding_balance > 0 else 'success' if summary.outstanding_balance == 0 else 'info' }}">
                            ${{ "%.2f"|format(summary.outstanding_balance) }}
                        </div>
                        <small class="text-muted">Outstanding Balance</small>
                    </div>
                </div>
                <hr>
                <div class="row text-center">
                    <div class="col-6">
                        <div class="text-warning h6">${{ "%.2f"|format(summary.total_vouchers_payable) }}</div>
                        <small class="text-muted">Total VPs</small>
                    </div>
                    <div class="col-6">
                        <div class="text-success h6">${{ "%.2f"|format(summary.total_payments) }}</div>
                        <small class="text-muted">Total Paid</small>
                    </div>
                </div>
                <hr>
                <div class="row text-center">
                    <div class="col-4">
                        <div class="text-info h6">{{ summary.transaction_count }}</div>
                        <small class="text-muted">Total</small>
                    </div>
                    <div class="col-4">
                        <div class="text-warning h6">{{ summary.vp_count }}</div>
                        <small class="text-muted">VPs</small>
                    </div>
                    <div class="col-4">
                        <div class="text-success h6">{{ summary.cv_count }}</div>
                        <small class="text-muted">CVs</small>
                    </div>
                </div>
                
                {% if summary.avg_vp_amount > 0 or summary.avg_cv_amount > 0 %}
                <hr>
                <div class="row text-center">
                    <div class="col-6">
                        <div class="small text-muted">Avg VP</div>
                        <div>${{ "%.2f"|format(summary.avg_vp_amount) }}</div>
                    </div>
                    <div class="col-6">
                        <div class="small text-muted">Avg CV</div>
                        <div>${{ "%.2f"|format(summary.avg_cv_amount) }}</div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Pending VPs (Outstanding Balances) -->
{% if pending_vps %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h6 class="card-title mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>Outstanding Vouchers Payable
                </h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr>
                                <th>VP Number</th>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Due Date</th>
                                <th>Days Outstanding</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for vp in pending_vps %}
                            <tr>
                                <td><strong>{{ vp.number }}</strong></td>
                                <td>{{ vp.date }}</td>
                                <td>{{ vp.description }}</td>
                                <td class="text-end"><strong>${{ "%.2f"|format(vp.total_amount) }}</strong></td>
                                <td>
                                    {% if vp.due_date %}
                                        {{ vp.due_date }}
                                    {% else %}
                                        <span class="text-muted">No due date</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if vp.due_date %}
                                        {% set days_outstanding = (moment().date() - moment(vp.due_date).date()).days %}
                                        <span class="badge bg-{{ 'danger' if days_outstanding > 30 else 'warning' if days_outstanding > 0 else 'secondary' }}">
                                            {{ days_outstanding }} days
                                        </span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{{ url_for('accounting.view_transaction', transaction_number=vp.number) }}" 
                                           class="btn btn-sm btn-outline-primary" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{{ url_for('accounting.create_check_voucher') }}?vp={{ vp.number }}" 
                                           class="btn btn-sm btn-success" title="Pay Now">
                                            <i class="fas fa-credit-card"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Transaction History -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history me-2"></i>Transaction History
                </h5>
                <div class="btn-group" role="group">
                    <button class="btn btn-outline-secondary btn-sm" onclick="filterTransactions('all')" id="filterAll">
                        All
                    </button>
                    <button class="btn btn-outline-warning btn-sm" onclick="filterTransactions('VP')" id="filterVP">
                        VPs
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="filterTransactions('CV')" id="filterCV">
                        CVs
                    </button>
                </div>
            </div>
            <div class="card-body">
                {% if transactions %}
                <div class="table-responsive">
                    <table class="table table-striped" id="transactionTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Number</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for transaction in transactions %}
                            <tr class="transaction-row" data-type="{{ transaction.type }}">
                                <td>{{ transaction.date }}</td>
                                <td><strong>{{ transaction.number }}</strong></td>
                                <td>
                                    <span class="badge bg-{{ 'warning' if transaction.type == 'VP' else 'success' }}">
                                        {{ transaction.type }}
                                    </span>
                                </td>
                                <td>
                                    {{ transaction.description }}
                                    {% if transaction.type == 'CV' and 'Check #' in transaction.description %}
                                        <br><small class="text-muted">{{ transaction.description.split('Check #')[1].split(' ')[0] if 'Check #' in transaction.description else '' }}</small>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <strong class="text-{{ 'warning' if transaction.type == 'VP' else 'success' }}">
                                        ${{ "%.2f"|format(transaction.total_amount) }}
                                    </strong>
                                </td>
                                <td>
                                    <span class="badge bg-{{ 'success' if transaction.status == 'completed' else 'warning' if transaction.status == 'active' else 'secondary' }}">
                                        {{ transaction.status|title }}
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{{ url_for('accounting.view_transaction', transaction_number=transaction.number) }}" 
                                           class="btn btn-sm btn-outline-primary" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        {% if transaction.type == 'VP' and transaction.status == 'active' %}
                                        <a href="{{ url_for('accounting.create_check_voucher') }}?vp={{ transaction.number }}" 
                                           class="btn btn-sm btn-success" title="Pay">
                                            <i class="fas fa-credit-card"></i>
                                        </a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-file-invoice fa-3x text-muted mb-3"></i>
                    <h6 class="text-muted">No Transactions Yet</h6>
                    <p class="text-muted">No transactions found for this payee.</p>
                    <div class="btn-group" role="group">
                        <a href="{{ url_for('accounting.create_voucher_payable') }}?payee={{ payee.acct_code }}" 
                           class="btn btn-primary">
                            <i class="fas fa-file-invoice me-2"></i>Create VP
                        </a>
                        <a href="{{ url_for('accounting.create_check_voucher') }}?payee={{ payee.acct_code }}" 
                           class="btn btn-success">
                            <i class="fas fa-check me-2"></i>Create CV
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Monthly Activity Summary -->
{% if monthly_summary %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">Monthly Activity Summary</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for month, data in monthly_summary.items() %}
                    <div class="col-md-3 mb-3">
                        <div class="border rounded p-3 text-center">
                            <h6>{{ moment(month + '-01').format('MMM YYYY') }}</h6>
                            <div class="row">
                                <div class="col-6">
                                    <div class="text-warning small">VPs</div>
                                    <div>${{ "%.0f"|format(data.vp_amount) }}</div>
                                    <small class="text-muted">({{ data.vp_count }})</small>
                                </div>
                                <div class="col-6">
                                    <div class="text-success small">CVs</div>
                                    <div>${{ "%.0f"|format(data.cv_amount) }}</div>
                                    <small class="text-muted">({{ data.cv_count }})</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Back Button -->
<div class="row mt-3">
    <div class="col-12">
        <a href="{{ url_for('accounting.list_payees') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Payees
        </a>
    </div>
</div>

<script>
function filterTransactions(type) {
    const rows = document.querySelectorAll('.transaction-row');
    const buttons = document.querySelectorAll('[id^="filter"]');
    
    // Reset button styles
    buttons.forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-secondary');
    });
    
    // Highlight active filter
    const activeButton = document.getElementById('filter' + (type === 'all' ? 'All' : type));
    if (activeButton) {
        activeButton.classList.remove('btn-outline-secondary');
        activeButton.classList.add('btn-primary');
    }
    
    // Show/hide rows
    rows.forEach(row => {
        if (type === 'all' || row.dataset.type === type) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function exportPayeeData() {
    // Export payee transaction data
    const payeeCode = '{{ payee.acct_code }}';
    const payeeName = '{{ payee.acct_description }}';
    
    let csv = 'Date,Transaction Number,Type,Description,Amount,Status\n';
    
    const rows = document.querySelectorAll('.transaction-row');
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        csv += `"${cells[0].textContent.trim()}","${cells[1].textContent.trim()}","${cells[2].textContent.trim()}","${cells[3].textContent.trim()}","${cells[4].textContent.trim()}","${cells[5].textContent.trim()}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.setAttribute('hidden', '');
    a.setAttribute('href', url);
    a.setAttribute('download', `payee_${payeeCode}_transactions.csv`);
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

// Initialize with all transactions shown
document.addEventListener('DOMContentLoaded', function() {
    filterTransactions('all');
});
</script>
{% endblock %}


<!-- templates/accounting/payees/edit.html -->
{% extends "base.html" %}

{% block title %}Edit {{ payee.acct_description }}{% endblock %}
{% block page_title %}Edit Payee{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-edit me-2"></i>Edit Payee: {{ payee.acct_code }}
                </h5>
                <p class="mb-0 text-muted">Update payee information</p>
            </div>
            <div class="card-body">
                <form method="POST" id="editPayeeForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="payee_code" class="form-label">Payee Code</label>
                                <input type="text" class="form-control" id="payee_code" value="{{ payee.acct_code }}" readonly>
                                <div class="form-text">Payee code cannot be changed</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="payee_type" class="form-label">Payee Type <span class="text-danger">*</span></label>
                                <select class="form-select" id="payee_type" name="payee_type" required>
                                    <option value="Company" {{ 'selected' if payee.acct_type == 'Company' }}>Company</option>
                                    <option value="Vendor" {{ 'selected' if payee.acct_type == 'Vendor' }}>Vendor</option>
                                    <option value="Customer" {{ 'selected' if payee.acct_type == 'Customer' }}>Customer</option>
                                    <option value="Employee" {{ 'selected' if payee.acct_type == 'Employee' }}>Employee</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="payee_name" class="form-label">Payee Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="payee_name" name="payee_name" 
                               value="{{ payee.acct_description }}" required>
                        <div class="form-text">Full legal name of the payee</div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="contact_email" class="form-label">Contact Email</label>
                                <input type="email" class="form-control" id="contact_email" name="contact_email"
                                       placeholder="contact@company.com">
                                <div class="form-text">Primary email for correspondence</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="contact_phone" class="form-label">Contact Phone</label>
                                <input type="tel" class="form-control" id="contact_phone" name="contact_phone"
                                       placeholder="(555) 123-4567">
                                <div class="form-text">Primary phone number</div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="address" class="form-label">Address</label>
                        <textarea class="form-control" id="address" name="address" rows="3"
                                  placeholder="Street address, city, state, zip code"></textarea>
                        <div class="form-text">Full mailing address</div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="payment_terms" class="form-label">Payment Terms</label>
                                <select class="form-select" id="payment_terms" name="payment_terms">
                                    <option value="">Select terms</option>
                                    <option value="Net 15">Net 15</option>
                                    <option value="Net 30">Net 30</option>
                                    <option value="Net 45">Net 45</option>
                                    <option value="Net 60">Net 60</option>
                                    <option value="Due on Receipt">Due on Receipt</option>
                                    <option value="COD">Cash on Delivery</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="tax_id" class="form-label">Tax ID / EIN</label>
                                <input type="text" class="form-control" id="tax_id" name="tax_id"
                                       placeholder="XX-XXXXXXX">
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> Changes to payee information will affect future transactions but will not modify existing transactions.
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Save Changes
                        </button>
                        <a href="{{ url_for('accounting.view_payee', payee_code=payee.acct_code) }}" class="btn btn-secondary">
                            <i class="fas fa-times me-2"></i>Cancel
                        </a>
                        <button type="button" class="btn btn-outline-danger" onclick="confirmDeactivate()">
                            <i class="fas fa-ban me-2"></i>Deactivate Payee
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Payee Usage Info -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">Payee Usage</h6>
            </div>
            <div class="card-body">
                <dl class="mb-0">
                    <dt>Created</dt>
                    <dd>{{ moment(payee.created_at).format('MMM DD, YYYY') if payee.created_at else 'Unknown' }}</dd>
                    
                    <dt>Last Updated</dt>
                    <dd>{{ moment(payee.updated_at).format('MMM DD, YYYY') if payee.updated_at else 'Never' }}</dd>
                    
                    <dt>Status</dt>
                    <dd>
                        <span class="badge bg-{{ 'success' if payee.is_active else 'secondary' }}">
                            {{ 'Active' if payee.is_active else 'Inactive' }}
                        </span>
                    </dd>
                    
                    <dt>Prefix</dt>
                    <dd>{{ payee.acct_prefix or 'None' }}</dd>
                </dl>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h6 class="card-title mb-0">Quick Actions</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('accounting.view_payee', payee_code=payee.acct_code) }}" 
                       class="btn btn-outline-primary">
                        <i class="fas fa-eye me-2"></i>View Details
                    </a>
                    <a href="{{ url_for('accounting.create_voucher_payable') }}?payee={{ payee.acct_code }}" 
                       class="btn btn-outline-success">
                        <i class="fas fa-file-invoice me-2"></i>Create VP
                    </a>
                    <a href="{{ url_for('accounting.create_check_voucher') }}?payee={{ payee.acct_code }}" 
                       class="btn btn-outline-info">
                        <i class="fas fa-check me-2"></i>Create CV
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function confirmDeactivate() {
    const payeeCode = '{{ payee.acct_code }}';
    const payeeName = '{{ payee.acct_description }}';
    
    if (confirm(`Are you sure you want to deactivate payee ${payeeCode} (${payeeName})?\n\nThis will prevent the payee from being used in new transactions.`)) {
        fetch(`/accounting/payees/${payeeCode}/deactivate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.href = "{{ url_for('accounting.list_payees') }}";
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error deactivating payee: ' + error.message);
        });
    }
}

// Auto-update form help text based on payee type
document.getElementById('payee_type').addEventListener('change', function() {
    const type = this.value;
    const nameInput = document.getElementById('payee_name');
    
    switch(type) {
        case 'Company':
            nameInput.placeholder = 'Enter company name';
            break;
        case 'Vendor':
            nameInput.placeholder = 'Enter vendor/supplier name';
            break;
        case 'Customer':
            nameInput.placeholder = 'Enter customer name';
            break;
        case 'Employee':
            nameInput.placeholder = 'Enter employee name';
            break;
    }
});
</script>
{% endblock %}
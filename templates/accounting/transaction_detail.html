<!-- templates/accounting/transaction_detail.html -->
{% extends "base.html" %}

{% block title %}Transaction {{ transaction.ledger.number }}{% endblock %}
{% block page_title %}Transaction Details{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <!-- Transaction Header -->
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-{{ 'file-invoice' if transaction.ledger.type == 'VP' else 'check' }} me-2"></i>
                        {{ 'Voucher Payable' if transaction.ledger.type == 'VP' else 'Check Voucher' }} 
                        {{ transaction.ledger.number }}
                    </h5>
                    <div>
                        <span class="badge bg-{{ 'success' if transaction.ledger.status == 'active' else 'secondary' if transaction.ledger.status == 'void' else 'warning' }} fs-6">
                            {{ transaction.ledger.status|title }}
                        </span>
                        {% if not transaction.is_balanced %}
                        <span class="badge bg-danger fs-6 ms-1">
                            <i class="fas fa-exclamation-triangle me-1"></i>Unbalanced
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <dl class="row">
                            <dt class="col-sm-4">Date:</dt>
                            <dd class="col-sm-8">{{ transaction.ledger.date }}</dd>
                            
                            <dt class="col-sm-4">Payee:</dt>
                            <dd class="col-sm-8">
                                <strong>{{ transaction.ledger.payee }}</strong>
                                <br><small class="text-muted">{{ transaction.ledger.payee_code }}</small>
                            </dd>
                            
                            <dt class="col-sm-4">Total Amount:</dt>
                            <dd class="col-sm-8">
                                <h5 class="text-primary mb-0">${{ "%.2f"|format(transaction.ledger.total_amount) }}</h5>
                            </dd>
                            
                            {% if transaction.ledger.due_date %}
                            <dt class="col-sm-4">Due Date:</dt>
                            <dd class="col-sm-8">
                                {{ transaction.ledger.due_date }}
                                {% set due_date = transaction.ledger.due_date|as_date %}
                                {% set today = moment().date() %}
                                {% if due_date < today %}
                                    <span class="badge bg-danger ms-1">Overdue</span>
                                {% elif (due_date - today).days <= 7 %}
                                    <span class="badge bg-warning ms-1">Due Soon</span>
                                {% endif %}
                            </dd>
                            {% endif %}
                        </dl>
                    </div>
                    <div class="col-md-6">
                        <dl class="row">
                            <dt class="col-sm-4">Created By:</dt>
                            <dd class="col-sm-8">{{ transaction.ledger.created_by_username or 'System' }}</dd>
                            
                            <dt class="col-sm-4">Created:</dt>
                            <dd class="col-sm-8">{{ transaction.ledger.created_at }}</dd>
                            
                            <dt class="col-sm-4">Updated:</dt>
                            <dd class="col-sm-8">{{ transaction.ledger.updated_at }}</dd>
                            
                            {% if transaction.ledger.description %}
                            <dt class="col-sm-4">Description:</dt>
                            <dd class="col-sm-8">{{ transaction.ledger.description }}</dd>
                            {% endif %}
                        </dl>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Credit/Debit Entries -->
        <div class="card mt-4">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-balance-scale me-2"></i>Credit/Debit Entries
                    </h6>
                    <div class="badge bg-{{ 'success' if transaction.is_balanced else 'danger' }}">
                        {{ 'Balanced' if transaction.is_balanced else 'Unbalanced' }}
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% if transaction.credit_debit_entries %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>Account Code</th>
                                <th>Account Description</th>
                                <th>Debit</th>
                                <th>Credit</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for entry in transaction.credit_debit_entries %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('accounting.view_account_ledger', acct_code=entry.acct_code) }}" 
                                       class="text-decoration-none">
                                        <strong>{{ entry.acct_code }}</strong>
                                    </a>
                                </td>
                                <td>{{ entry.acct_description }}</td>
                                <td class="text-end">
                                    {% if entry.acct_type == 'D' %}
                                        <strong>${{ "%.2f"|format(entry.amount) }}</strong>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    {% if entry.acct_type == 'C' %}
                                        <strong>${{ "%.2f"|format(entry.amount) }}</strong>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <th colspan="2">Totals:</th>
                                <th class="text-end">${{ "%.2f"|format(transaction.balance_check.total_debits) }}</th>
                                <th class="text-end">${{ "%.2f"|format(transaction.balance_check.total_credits) }}</th>
                            </tr>
                            {% if transaction.balance_check.difference > 0 %}
                            <tr class="table-warning">
                                <th colspan="2">Difference:</th>
                                <th colspan="2" class="text-end text-danger">
                                    ${{ "%.2f"|format(transaction.balance_check.difference) }}
                                </th>
                            </tr>
                            {% endif %}
                        </tfoot>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-3">
                    <i class="fas fa-info-circle fa-2x mb-2"></i>
                    <p class="mb-0">No credit/debit entries found</p>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Subsidiary Entries -->
        {% if transaction.subsidiary_entries %}
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-sitemap me-2"></i>Subsidiary Breakdown
                </h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>Account</th>
                                <th>Subsidiary Code</th>
                                <th>Subsidiary Description</th>
                                <th class="text-end">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for entry in transaction.subsidiary_entries %}
                            <tr>
                                <td>
                                    <strong>{{ entry.acct_code }}</strong>
                                    <br><small class="text-muted">{{ entry.acct_description }}</small>
                                </td>
                                <td><strong>{{ entry.subsidiary_code }}</strong></td>
                                <td>{{ entry.subsidiary_description }}</td>
                                <td class="text-end">
                                    <strong>${{ "%.2f"|format(entry.amount) }}</strong>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <th colspan="3">Total Subsidiary:</th>
                                <th class="text-end">
                                    {% set sub_total = transaction.subsidiary_entries|sum(attribute='amount') %}
                                    ${{ "%.2f"|format(sub_total) }}
                                </th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Action Panel -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">Actions</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if transaction.ledger.status == 'active' %}
                        {% if transaction.ledger.type == 'VP' %}
                        <a href="{{ url_for('accounting.create_check_voucher') }}?vp_number={{ transaction.ledger.number }}" 
                           class="btn btn-success">
                            <i class="fas fa-check me-2"></i>Create Check Voucher
                        </a>
                        {% endif %}
                        
                        <button class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#voidModal">
                            <i class="fas fa-ban me-2"></i>Void Transaction
                        </button>
                    {% endif %}
                    
                    <a href="#" class="btn btn-outline-info" onclick="window.print()">
                        <i class="fas fa-print me-2"></i>Print
                    </a>
                    
                    <a href="{{ url_for('accounting.list_vouchers_payable' if transaction.ledger.type == 'VP' else 'accounting.list_check_vouchers') }}" 
                       class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to List
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Balance Information -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="card-title mb-0">Balance Information</h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="border-end">
                            <h6 class="text-success">${{ "%.2f"|format(transaction.balance_check.total_debits) }}</h6>
                            <small class="text-muted">Total Debits</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <h6 class="text-danger">${{ "%.2f"|format(transaction.balance_check.total_credits) }}</h6>
                        <small class="text-muted">Total Credits</small>
                    </div>
                </div>
                
                {% if transaction.balance_check.difference > 0.01 %}
                <div class="alert alert-warning mt-3 mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Difference:</strong> ${{ "%.2f"|format(transaction.balance_check.difference) }}
                </div>
                {% else %}
                <div class="alert alert-success mt-3 mb-0">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Balanced Transaction</strong>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Related Transactions -->
        {% if transaction.ledger.type == 'VP' %}
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="card-title mb-0">Related Check Vouchers</h6>
            </div>
            <div class="card-body">
                <!-- In a real implementation, you would query for CVs that reference this VP -->
                <div class="text-center text-muted py-2">
                    <small>No related check vouchers found</small>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Audit Trail -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="card-title mb-0">Audit Trail</h6>
            </div>
            <div class="card-body">
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-marker bg-primary"></div>
                        <div class="timeline-content">
                            <h6 class="timeline-title">Transaction Created</h6>
                            <p class="timeline-text">
                                By {{ transaction.ledger.created_by_username or 'System' }}
                                <br><small class="text-muted">{{ transaction.ledger.created_at }}</small>
                            </p>
                        </div>
                    </div>
                    
                    {% if transaction.ledger.updated_at != transaction.ledger.created_at %}
                    <div class="timeline-item">
                        <div class="timeline-marker bg-warning"></div>
                        <div class="timeline-content">
                            <h6 class="timeline-title">Transaction Updated</h6>
                            <p class="timeline-text">
                                <small class="text-muted">{{ transaction.ledger.updated_at }}</small>
                            </p>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if transaction.ledger.status == 'void' %}
                    <div class="timeline-item">
                        <div class="timeline-marker bg-danger"></div>
                        <div class="timeline-content">
                            <h6 class="timeline-title">Transaction Voided</h6>
                            <p class="timeline-text">
                                <small class="text-muted">{{ transaction.ledger.updated_at }}</small>
                            </p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Void Transaction Modal -->
<div class="modal fade" id="voidModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Void Transaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('accounting.void_transaction', number=transaction.ledger.number) }}">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> Voiding this transaction will mark it as void and it cannot be undone.
                    </div>
                    
                    <div class="mb-3">
                        <label for="reason" class="form-label">Reason for voiding <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="reason" name="reason" rows="3" 
                                  placeholder="Enter the reason for voiding this transaction" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <strong>Transaction Details:</strong>
                        <ul class="mb-0">
                            <li>Number: {{ transaction.ledger.number }}</li>
                            <li>Payee: {{ transaction.ledger.payee }}</li>
                            <li>Amount: ${{ "%.2f"|format(transaction.ledger.total_amount) }}</li>
                            <li>Date: {{ transaction.ledger.date }}</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-ban me-2"></i>Void Transaction
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Auto-refresh balance check
function refreshBalanceCheck() {
    fetch(`/accounting/api/transaction/{{ transaction.ledger.number }}/balance-check`)
        .then(response => response.json())
        .then(data => {
            // Update balance information in real-time
            console.log('Balance check updated:', data);
        })
        .catch(error => {
            console.error('Error refreshing balance check:', error);
        });
}

// Check balance every 30 seconds
setInterval(refreshBalanceCheck, 30000);

// Print functionality
function printTransaction() {
    const printContent = document.querySelector('.row').innerHTML;
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>Transaction {{ transaction.ledger.number }}</title>
            <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
            <style>
                @media print {
                    .btn, .card-header .badge, .modal { display: none !important; }
                    .card { border: 1px solid #dee2e6 !important; }
                    .col-md-4 { display: none !important; }
                    .col-md-8 { width: 100% !important; }
                }
            </style>
        </head>
        <body class="p-3">
            <div class="container-fluid">${printContent}</div>
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}
</script>

<style>
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #dee2e6;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -22px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid white;
}

.timeline-content {
    background: #f8f9fa;
    padding: 10px 15px;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.timeline-title {
    margin: 0 0 5px 0;
    font-size: 0.9rem;
    font-weight: 600;
}

.timeline-text {
    margin: 0;
    font-size: 0.85rem;
}

.badge.fs-6 {
    font-size: 0.9rem !important;
}

@media print {
    .btn, .modal, .card-header .badge {
        display: none !important;
    }
    
    .col-md-4 {
        display: none !important;
    }
    
    .col-md-8 {
        width: 100% !important;
        max-width: 100% !important;
    }
}
</style>
{% endblock %}